global.NSP=METHOD(function(e){var t,n,r,o=require("path"),i={},s=SHARED_STORE("__NSP_SHARED_STORE");return e.getSavedCodes=t=function(){return i},e.getSharedStore=n=function(){return s},e.generateErrorDisplay=r=function(e){var t="";return t+="<p><b>"+e.error+"</b></p>",t+="<p><b>path: </b>"+e.path+" ("+e.startLine+":"+e.startColumn+"~"+e.endLine+":"+e.endColumn+")</p>",t+="<pre>"+i[e.path].substring(e.startIndex,e.endIndex)+"</pre>"},e.require=require,{run:function(e){var t,n,r,s,u,a,_,c,f,p=e.path,d=e.code,l=e.isNotUsingDCBN,h=e.preprocessor,m="",S=0,v=0,E=1,C=1,g=0,I=0,T=[0],N=!1,P=!1,L=!1,R=!1,x=!1,U=!1,b=!1,H=!1,D=!1,y=function(){return N===!0||L===!0||R===!0||x===!0},A=function(){return U===!0||b===!0||H===!0||D===!0},k=function(){T[T.length-1]+=1,m+="__pauseCount += 1;",m+="__store.resume = resume = function() { __pauseCount -= 1; if (__pauseCount === 0 && __store.doneResumeIndexes["+S+"] !== true) { __store.doneResumeIndexes["+S+"] = true;"},q=function(e){m+="var __pauseCount = 0;",m+="var __lastCondition;",m+="var __store = { doneResumeIndexes: {} };",m+="var resume;",m+="var pause = "+function(){__pauseCount+=1}.toString()+";",m+="var include = "+function(e){LOAD_NSP({requestInfo:__requestInfo,path:__basePath+"/"+e,self:self},{notExists:function(){print(e+": File not exists."),resume()},error:function(e,t,n,r,o,i,s,u){print(NSP.generateErrorDisplay({path:t,startIndex:s,endIndex:u,startLine:n,startColumn:r,endLine:o,endColumn:i,error:e}))},success:function(e){print(e.html),resume()}}),pause()}.toString()+";",e===!0?m+="__store.resume = resume = function() { __pauseCount -= 1; };":k()};for(i[p]=d,RUN(function(){m+="var __html = '';",m+="var __redirectURL;",m+="var __cookieInfo = __requestInfo.cookies;",m+="var __newCookieInfo = {};",m+="var __basePath = '"+o.dirname(p)+"';",m+="var print = "+function(e){void 0!==e&&("string"==typeof e?__html+=e:__html+=JSON.stringify(e))}.toString()+";",m+="var save = "+function(e,t){void 0===t?NSP.getSharedStore().remove(e):NSP.getSharedStore().save({name:e,value:t})}.toString()+";",m+="var load = "+function(e){return NSP.getSharedStore().get(e)}.toString()+";",m+="var cookie = "+function(e,t,n,r,o){return void 0===t?(t=__cookieInfo[e],CHECK_IS_DATA(t)===!0?t.value:t):(__newCookieInfo[e]=__cookieInfo[e]={value:t,expireSeconds:n,path:r,domain:o},t)}.toString()+";",m+="var upload = "+function(e,t){var n,r,o;CHECK_IS_DATA(t)!==!0?n=t:(n=t.success,r=t.error,o=t.overFileSize),UPLOAD_REQUEST({requestInfo:__requestInfo,uploadPath:__basePath+"/"+e},{error:r,overFileSize:o,success:n})}.toString()+";",m+="var redirect = "+function(e){__redirectURL=e,__handler({cookies:__newCookieInfo,redirectURL:__redirectURL})}.toString()+";",m+="var __each = "+function(e,t){isNaN(e)===!0?EACH(e,function(e,n){t(n,e)}):REPEAT(e,function(e){t(void 0,e)})}.toString()+";",q(!0),m+="print('"});S<d.length;S+=1)if(g+=1,s=d[S],u=s+d[S+1],"<%"!==u||y()===!0)if("%>"!==u||A()===!0||N!==!0)if("<?"!==u||y()===!0)if("<~"!==u||y()===!0)if("->"!==u||A()===!0||R!==!0)if(":"!==s||A()===!0||R!==!0)if("el"!==u||"s"!==d[S+2]||"e"!==d[S+3]||" "!==d[S+4]&&"\t"!==d[S+4]&&">"!==d[S+4]&&"\r"!==d[S+4]&&"\n"!==d[S+4]||A()===!0||L!==!0){if(">"===s&&A()!==!0){if(L===!0){L=!1,T.push(0),m+=") === true) { (function(__parentPause, __parentStore) {",q(),m+="print('";continue}if(R===!0){R=!1,T.push(0),r===-1&&(m+=", function(__name, __value"),m+=") { (function(__parentPause, __parentStore) {",q(),m+="print('";continue}}if("</"===u&&">"===d[S+3]&&y()!==!0){if("?"===d[S+2]){m+="');",REPEAT(T[T.length-1],function(e){0===e&&(m+="__parentStore.resume();"),m+="} }; resume();"}),T.pop(),m+="__parentPause(); } )(pause, __store); } } catch(e) { __errorHandler(e, __path, "+C+", "+I+", "+E+", "+(g+3)+", "+v+", "+(S+4)+"); }",k(),m+="print('",S+=3,g+=3;continue}if("~"===d[S+2]){m+="');",REPEAT(T[T.length-1],function(e){0===e&&(m+="__parentStore.resume();"),m+="} }; resume();"}),T.pop(),m+="__parentPause(); } )(pause, __store); } ); } catch(e) { __errorHandler(e, __path, "+C+", "+I+", "+E+", "+(g+3)+", "+v+", "+(S+4)+"); }",k(),m+="print('",S+=3,g+=3;continue}}if(l===!0||"{{"!==u||y()===!0)if(l===!0||"}}"!==u||A()===!0||x!==!0){if("'"===s){if(y()!==!0){m+="\\'";continue}if(A()!==!0){U=!0,m+="'";continue}if(U===!0){U=!1,m+="'";continue}}if('"'===s&&y()===!0){if(A()!==!0){b=!0,m+="'";continue}if(b===!0){b=!1,m+="'";continue}}if("//"!==u||y()!==!0||A()===!0)if("/*"!==u||y()!==!0||A()===!0)if("*/"!==u||y()!==!0||D!==!0){if("\n"===s){if(E+=1,g=0,y()===!0&&H===!0){H=!1,m+="\n";continue}if(y()!==!0){m+="\\n";continue}}"\\"!==s||y()===!0?"\r"!==s&&(m+=s):m+="\\\\"}else D=!1,m+="*/",S+=1,g+=1;else D=!0,m+="/*",S+=1,g+=1;else H=!0,m+="//",S+=1,g+=1}else x=!1,m+="); } catch(e) { __errorHandler(e, __path, "+C+", "+I+", "+E+", "+(g+1)+", "+v+", "+(S+2)+"); }",k(),m+="print('",S+=1,g+=1;else x=!0,m+="'); try { print(",C=E,I=g,v=S,S+=1,g+=1}else m+="__lastCondition !== true",S+=3,g+=3;else m+=", ";else for(m+=", function(",S+=1,g+=1,r=S+1;r<d.length;r+=1){if(">"===d[r]){m+="__name, ";break}if(":"===d[r])break}else R=!0,m+="'); try { __each(",C=E,I=g,v=S,S+=1,r=-1,g+=1;else L=!0,m+="'); try { if (__lastCondition = (",C=E,I=g,v=S,S+=1,g+=1;else N=!1,P===!0&&(P=!1,m+=");"),void 0===n?(n=S+2,_=E,f=g+1):m+="} catch(e) { __errorHandler(e, __path, "+C+", "+I+", "+E+", "+(g+1)+", "+v+", "+(S+2)+"); }",k(),m+="print('",S+=1,g+=1;else N=!0,C=E,I=g,v=S,void 0===t?(t=S,a=E,c=g,m+="');"):m+="'); try {","="===d[S+2]?(P=!0,m+="print(",S+=2,g+=2):(S+=1,g+=1);return m+="'); __handler({ html: __html, cookies: __newCookieInfo });",REPEAT(T[0],function(){m+="} }; resume();"}),void 0!==h&&(m=h(m)),void 0!==t&&(m="try {"+m+"} catch(e) { __errorHandler(e, __path, "+a+", "+c+", "+_+", "+f+", "+t+", "+n+"); }"),m="var __path = '"+p+"';"+m,m="var require = NSP.require;"+m}}}),global.LOAD_NSP=METHOD(function(e){var t={};return{run:function(e,n){var r=e.requestInfo,o=e.path,i=e.self,s=e.isNotUsingDCBN,u=e.preprocessor,a=n.notExists,_=n.error,c=n.success;GET_FILE_INFO(o,{notExists:a,success:function(e){var n=t[o];void 0!==n&&(void 0!==e.lastUpdateTime&&n.lastUpdateTime.getTime()===e.lastUpdateTime.getTime()||void 0!==e.createTime&&n.lastUpdateTime.getTime()===e.createTime.getTime())?n.run(r,i,_,c):READ_FILE(o,{notExists:a,error:_,success:function(n){var a=new Function("__requestInfo","self","__errorHandler","__handler",NSP({path:o,code:n.toString(),isNotUsingDCBN:s,preprocessor:u}));t[o]={lastUpdateTime:void 0===e.lastUpdateTime?e.createTime:e.lastUpdateTime,run:a},a(r,i,_,c)}})}})}}}),global.NSP_BRIDGE=METHOD(function(e){var t=require("path"),n=function(e,t,n,r,o,i,s,u,a){e({statusCode:500,content:'<!doctype html><html><head><meta charset="UTF-8"><title>'+t+"</title></head><body>"+NSP.generateErrorDisplay({path:n,startIndex:u,endIndex:a,startLine:r,startColumn:o,endLine:i,endColumn:s,error:t})+"</body></html>",contentType:"text/html"})},r=function(e){e({statusCode:404,content:'<!doctype html><html><head><meta charset="UTF-8"><title>Page not found.</title></head><body><p><b>Page not found.</b></p></body></html>',contentType:"text/html"})};return{run:function(e){var o=e.rootPath,i=e.restURI,s=e.isNotUsingDCBN,u=e.preprocessor,a=e.templateEngine;return{notExistsHandler:function(e,t,n){r(n)},requestListener:function(e,_,c,f){var p,d,l=e.uri,h="",m=function(){LOAD_NSP({requestInfo:e,path:p,self:{headers:e.headers,method:e.method,params:e.params,ip:e.ip,subURI:h},isNotUsingDCBN:s,preprocessor:u},{notExists:function(){r(_)},error:function(e,t,r,o,i,s,u,a){n(_,e,t,r,o,i,s,u,a)},success:function(e){_(void 0!==e.redirectURL?{statusCode:302,cookies:e.cookies,headers:{Location:e.redirectURL}}:{cookies:e.cookies,content:void 0===a?e.html:a(e.html),contentType:"text/html"})}})};return NEXT([function(e){""===l?CHECK_IS_FILE_EXISTS(o+"/index.nsp",function(t){l=t===!0?"index.nsp":"index.html",e()}):e()},function(){return function(){p=o+"/"+l,d=t.extname(l).toLowerCase(),".nsp"===d?m():""===d?NEXT([function(e){CHECK_IS_FILE_EXISTS(p+".nsp",function(t){t===!0?CHECK_IS_FOLDER(p+".nsp",function(t){t===!0?e():(p+=".nsp",m())}):e()})},function(e){return function(){void 0!==i?(CHECK_IS_ARRAY(i)===!0?CHECK_IS_IN({array:i,value:l})===!0?l=i+".nsp":EACH(i,function(e){if(e+"/"===l.substring(0,e.length+1))return h=l.substring(e.length+1),l=e+".nsp",!1}):i===l?l=i+".nsp":i+"/"===l.substring(0,i.length+1)&&(h=l.substring(i.length+1),l=i+".nsp"),CHECK_IS_FILE_EXISTS(o+"/"+l,function(t){t===!0?(p=o+"/"+l,m()):e()})):e()}},function(){return function(){CHECK_IS_FILE_EXISTS(p,function(e){e===!0?CHECK_IS_FOLDER(p,function(e){e===!0?(p+="/index.nsp",m()):f()}):f()})}}]):f()}}]),!1}}}}});