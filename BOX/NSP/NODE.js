global.NSP=METHOD(function(e){var n,t,r=require("path"),o={};return e.getSavedCodes=n=function(){return o},e.generateErrorDisplay=t=function(e){var n="";return n+="<p><b>"+e.error+"</b></p>",n+="<p><b>path: </b>"+e.path+" ("+e.startLine+":"+e.startColumn+"~"+e.endLine+":"+e.endColumn+")</p>",n+="<pre>"+o[e.path].substring(e.startIndex,e.endIndex)+"</pre>"},e.require=require,{run:function(e){var n,t,i,s,u,a,_,c,f,p=e.path,d=e.code,l=e.isNotUsingDCBN,h=e.preprocessor,m="",v=0,C=0,E=1,g=1,I=0,S=0,T=[0],N=!1,L=!1,x=!1,b=!1,U=!1,P=!1,R=!1,H=!1,y=!1,D=!1,k=function(){return N===!0||x===!0||b===!0||U===!0},A=function(){return P===!0||R===!0||H===!0||y===!0||D===!0},F=function(){T[T.length-1]+=1,m+="__pauseCount += 1;",m+="__store.resume = resume = function() { __pauseCount -= 1; if (__pauseCount === 0 && __store.doneResumeIndexes["+v+"] !== true) { __store.doneResumeIndexes["+v+"] = true;"},q=function(e){m+="var __pauseCount = 0;",m+="var __lastCondition;",m+="var __store = { doneResumeIndexes: {} };",m+="var resume;",m+="var pause = "+function(){__pauseCount+=1}.toString()+";",m+="var include = "+function(e){LOAD_NSP({requestInfo:__requestInfo,path:__basePath+"/"+e,self:self},{notExists:function(){print(e+": File not exists."),resume()},error:function(e,n,t,r,o,i,s,u){print(NSP.generateErrorDisplay({path:n,startIndex:s,endIndex:u,startLine:t,startColumn:r,endLine:o,endColumn:i,error:e}))},success:function(e){print(e.html),resume()}}),pause()}.toString()+";",e===!0?m+="__store.resume = resume = function() { __pauseCount -= 1; };":F()};for(o[p]=d,RUN(function(){m+="var __html = '';",m+="var __redirectURL;",m+="var __cookieInfo = __requestInfo.cookies;",m+="var __newCookieInfo = {};",m+="var __basePath = '"+r.dirname(p)+"';",m+="var print = "+function(e){void 0!==e&&("string"==typeof e?__html+=e:__html+=JSON.stringify(e))}.toString()+";",m+="var cookie = "+function(e,n,t,r,o){return void 0===n?(n=__cookieInfo[e],CHECK_IS_DATA(n)===!0?n.value:n):(__newCookieInfo[e]=__cookieInfo[e]={value:n,expireSeconds:t,path:r,domain:o},n)}.toString()+";",m+="var redirect = "+function(e){__redirectURL=e,__handler({cookies:__newCookieInfo,redirectURL:__redirectURL})}.toString()+";",m+="var __each = "+function(e,n){isNaN(e)===!0?EACH(e,function(e,t){n(t,e)}):REPEAT(e,function(e){n(void 0,e)})}.toString()+";",q(!0),m+="print('"});v<d.length;v+=1)if(I+=1,s=d[v],u=s+d[v+1],"<%"!==u||k()===!0)if("%>"!==u||A()===!0||N!==!0)if("<?"!==u||k()===!0)if("<~"!==u||k()===!0)if("->"!==u||A()===!0||b!==!0)if(":"!==s||A()===!0||b!==!0)if("el"!==u||"s"!==d[v+2]||"e"!==d[v+3]||" "!==d[v+4]&&"\t"!==d[v+4]&&">"!==d[v+4]&&"\r"!==d[v+4]&&"\n"!==d[v+4]||A()===!0||x!==!0){if(">"===s&&A()!==!0){if(x===!0){x=!1,T.push(0),m+=") === true) { (function(__parentPause, __parentStore) {",q(),m+="print('";continue}if(b===!0){b=!1,T.push(0),i===-1&&(m+=", function(__name, __value"),m+=") { (function(__parentPause, __parentStore) {",q(),m+="print('";continue}}if("</"===u&&">"===d[v+3]&&k()!==!0){if("?"===d[v+2]){m+="');",REPEAT(T[T.length-1],function(e){0===e&&(m+="__parentStore.resume();"),m+="} }; resume();"}),T.pop(),m+="__parentPause(); } )(pause, __store); } } catch(e) { __errorHandler(e, __path, "+g+", "+S+", "+E+", "+(I+3)+", "+C+", "+(v+4)+"); }",F(),m+="print('",v+=3,I+=3;continue}if("~"===d[v+2]){m+="');",REPEAT(T[T.length-1],function(e){0===e&&(m+="__parentStore.resume();"),m+="} }; resume();"}),T.pop(),m+="__parentPause(); } )(pause, __store); } ); } catch(e) { __errorHandler(e, __path, "+g+", "+S+", "+E+", "+(I+3)+", "+C+", "+(v+4)+"); }",F(),m+="print('",v+=3,I+=3;continue}}if(l===!0||"{{"!==u||k()===!0)if(l===!0||"}}"!==u||A()===!0||U!==!0){if("'"===s){if(k()!==!0){m+="\\'";continue}if(A()!==!0){P=!0,m+="'";continue}if(P===!0){P=!1,m+="'";continue}}if('"'===s&&k()===!0){if(A()!==!0){R=!0,m+='"';continue}if(R===!0){R=!1,m+='"';continue}}if("//"!==u||k()!==!0||A()===!0)if("/*"!==u||k()!==!0||A()===!0)if("*/"!==u||k()!==!0||y!==!0){if("/"===s&&k()===!0){if(A()!==!0){D=!0,m+="/";continue}if(D===!0){D=!1,m+="/";continue}}if("\n"===s){if(E+=1,I=0,k()===!0&&H===!0){H=!1,m+="\n";continue}if(k()!==!0){m+="\\n";continue}}"\\"!==s||k()===!0?"\r"!==s&&(m+=s):m+="\\\\"}else y=!1,m+="*/",v+=1,I+=1;else y=!0,m+="/*",v+=1,I+=1;else H=!0,m+="//",v+=1,I+=1}else U=!1,m+="); } catch(e) { __errorHandler(e, __path, "+g+", "+S+", "+E+", "+(I+1)+", "+C+", "+(v+2)+"); }",F(),m+="print('",v+=1,I+=1;else U=!0,m+="'); try { print(",g=E,S=I,C=v,v+=1,I+=1}else m+="__lastCondition !== true",v+=3,I+=3;else m+=", ";else for(m+=", function(",v+=1,I+=1,i=v+1;i<d.length;i+=1){if(">"===d[i]){m+="__name, ";break}if(":"===d[i])break}else b=!0,m+="'); try { __each(",g=E,S=I,C=v,v+=1,i=-1,I+=1;else x=!0,m+="'); try { if (__lastCondition = (",g=E,S=I,C=v,v+=1,I+=1;else N=!1,L===!0&&(L=!1,m+=");"),void 0===t?(t=v+2,_=E,f=I+1):m+="} catch(e) { __errorHandler(e, __path, "+g+", "+S+", "+E+", "+(I+1)+", "+C+", "+(v+2)+"); }",F(),m+="print('",v+=1,I+=1;else N=!0,g=E,S=I,C=v,void 0===n?(n=v,a=E,c=I,m+="');"):m+="'); try {","="===d[v+2]?(L=!0,m+="print(",v+=2,I+=2):(v+=1,I+=1);return m+="'); __handler({ html: __html, cookies: __newCookieInfo });",REPEAT(T[0],function(){m+="} }; resume();"}),void 0!==h&&(m=h(m)),void 0!==n&&(m="try {"+m+"} catch(e) { __errorHandler(e, __path, "+a+", "+c+", "+_+", "+f+", "+n+", "+t+"); }"),m="var __path = '"+p+"';"+m,m="var require = NSP.require;"+m}}}),global.LOAD_NSP=METHOD(function(e){var n={};return{run:function(e,t){var r=e.requestInfo,o=e.path,i=e.self,s=e.isNotUsingDCBN,u=e.preprocessor,a=t.notExists,_=t.error,c=t.success;GET_FILE_INFO(o,{notExists:a,success:function(e){var t=n[o];void 0!==t&&(void 0!==e.lastUpdateTime&&t.lastUpdateTime.getTime()===e.lastUpdateTime.getTime()||void 0!==e.createTime&&t.lastUpdateTime.getTime()===e.createTime.getTime())?t.run(r,i,_,c):READ_FILE(o,{notExists:a,error:_,success:function(t){var a=new Function("__requestInfo","self","__errorHandler","__handler",NSP({path:o,code:t.toString(),isNotUsingDCBN:s,preprocessor:u}));n[o]={lastUpdateTime:void 0===e.lastUpdateTime?e.createTime:e.lastUpdateTime,run:a},a(r,i,_,c)}})}})}}}),global.NSP_BRIDGE=METHOD(function(e){var n=require("path"),t=function(e,n,t,r,o,i,s,u,a){e({statusCode:500,content:'<!doctype html><html><head><meta charset="UTF-8"><title>'+n+"</title></head><body>"+NSP.generateErrorDisplay({path:t,startIndex:u,endIndex:a,startLine:r,startColumn:o,endLine:i,endColumn:s,error:n})+"</body></html>",contentType:"text/html"})},r=function(e){e({statusCode:404,content:'<!doctype html><html><head><meta charset="UTF-8"><title>Page not found.</title></head><body><p><b>Page not found.</b></p></body></html>',contentType:"text/html"})};return{run:function(e){var o=e.rootPath,i=e.restURI,s=e.isNotUsingDCBN,u=e.preprocessor,a=e.templateEngine,_=function(e,_,c,f){var p,d,l=e.uri,h="",m=function(){LOAD_NSP({requestInfo:e,path:p,self:{headers:e.headers,method:e.method,params:e.params,ip:e.ip,subURI:h,fileDataSet:_},isNotUsingDCBN:s,preprocessor:u},{notExists:function(){r(c)},error:function(e,n,r,o,i,s,u,a){t(c,e,n,r,o,i,s,u,a)},success:function(e){c(void 0!==e.redirectURL?{statusCode:302,cookies:e.cookies,headers:{Location:e.redirectURL}}:{cookies:e.cookies,content:void 0===a?e.html:a(e.html),contentType:"text/html"})}})};NEXT([function(e){""===l?CHECK_FILE_EXISTS(o+"/index.nsp",function(n){l=n===!0?"index.nsp":"index.html",e()}):e()},function(){return function(){p=o+"/"+l,d=n.extname(l).toLowerCase(),".nsp"===d?m():""===d?NEXT([function(e){CHECK_FILE_EXISTS(p+".nsp",function(n){n===!0?CHECK_IS_FOLDER(p+".nsp",function(n){n===!0?e():(p+=".nsp",m())}):e()})},function(e){return function(){void 0!==i?(CHECK_IS_ARRAY(i)===!0?CHECK_IS_IN({array:i,value:l})===!0?l=i+".nsp":EACH(i,function(e){if(e+"/"===l.substring(0,e.length+1))return h=l.substring(e.length+1),l=e+".nsp",!1}):i===l?l=i+".nsp":i+"/"===l.substring(0,i.length+1)&&(h=l.substring(i.length+1),l=i+".nsp"),CHECK_FILE_EXISTS(o+"/"+l,function(n){n===!0?(p=o+"/"+l,m()):e()})):e()}},function(){return function(){CHECK_FILE_EXISTS(p,function(e){e===!0?CHECK_IS_FOLDER(p,function(e){e===!0?(p+="/index.nsp",m()):f()}):f()})}}]):f()}}])};return{uploadOverFileSize:function(e,n,t,r){_(t,void 0,r,function(){})},uploadSuccess:function(e,n,t,r){_(t,n,r,function(){})},notExistsHandler:function(e,n,t){r(t)},requestListener:function(e,n,t,r){return _(e,void 0,n,r),!1}}}}});